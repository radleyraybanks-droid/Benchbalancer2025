<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Algorithm Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .test-container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 8px; background: #2a2a2a; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #0d7377; color: white; }
        .error { background: #d32f2f; color: white; }
        .warning { background: #f57c00; color: white; }
        .info { background: #1976d2; color: white; }
        button { padding: 10px 20px; margin: 5px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #2980b9; }
        .log-output { background: #000; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; margin: 10px 0; }
        .algorithm-comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .algorithm-result { padding: 15px; border-radius: 8px; border: 2px solid #333; }
        .dynamic-result { border-color: #00d9ff; }
        .original-result { border-color: #orange; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üßÆ Dynamic Perfect Balance Algorithm - Integration Test</h1>
        <p>This test verifies that the Dynamic Perfect Balance Algorithm is properly integrated with Version 4.</p>
        
        <div class="test-section">
            <h2>üîß Script Loading Test</h2>
            <div id="script-loading-results"></div>
            <button onclick="testScriptLoading()">Test Script Loading</button>
        </div>
        
        <div class="test-section">
            <h2>üöÄ Algorithm Functionality Test</h2>
            <div id="algorithm-test-results"></div>
            <button onclick="testAlgorithmFunctionality()">Test Dynamic Algorithm</button>
        </div>
        
        <div class="test-section">
            <h2>üìä Algorithm Comparison Test</h2>
            <div id="comparison-results"></div>
            <button onclick="runAlgorithmComparison()">Compare Algorithms</button>
        </div>
        
        <div class="test-section">
            <h2>üîÑ Recalculation Test</h2>
            <div id="recalculation-results"></div>
            <button onclick="testRecalculationCapability()">Test Recalculation</button>
        </div>
        
        <div class="log-output" id="test-log"></div>
    </div>

    <!-- Load all necessary scripts in order -->
    <script src="constants.js?v=4"></script>
    <script src="utility-functions.js?v=4"></script>
    <script src="dynamic-perfect-algorithm.js?v=4"></script>
    <script src="lineup-generators.js?v=4"></script>
    <script src="substitution-logic.js?v=4"></script>
    <script src="variance-tracker.js?v=4"></script>

    <script>
        // Test logging
        let testLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testLog.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateLogDisplay();
            console.log(`${type.toUpperCase()}: ${message}`);
        }
        
        function updateLogDisplay() {
            const logElement = document.getElementById('test-log');
            logElement.innerHTML = testLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function showResult(containerId, message, type) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }
        
        // Mock some global variables that the algorithms expect
        window.gameSettings = {
            numPeriods: 2,
            subsPerChange: 2,
            numOnField: 5,
            numGoalkeepers: 0
        };
        
        window.periodLengthSeconds = 1200; // 20 minutes
        window.playerGKStatus = {};
        window.playerRemovedStatus = {};
        window.allPlayers = ['P1', 'P2', 'P3', 'P4', 'P5', 'P6', 'P7', 'P8'];
        window.onField = ['P1', 'P2', 'P3', 'P4', 'P5'];
        window.onBench = ['P6', 'P7', 'P8'];
        window.playerPlayTimes = {};
        window.playerCurrentStintStart = {};
        window.currentGameSeconds = 0;
        
        // Mock functions
        window.formatTime = function(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        };
        
        window.debugLog = function(message, data) {
            log(`DEBUG: ${message}${data ? ' | Data: ' + JSON.stringify(data) : ''}`);
        };
        
        // Test functions
        function testScriptLoading() {
            log('Starting script loading test...');
            const container = 'script-loading-results';
            
            // Clear previous results
            document.getElementById(container).innerHTML = '';
            
            // Test if core functions are loaded
            const requiredFunctions = [
                'calculateDynamicPerfectPlan',
                'calculateOptimalLineups', 
                'calculateOptimalSubstitutionPattern',
                'triggerPerfectBalanceRecalculation',
                'shouldAdjustStrategy'
            ];
            
            let loadedCount = 0;
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    showResult(container, `‚úÖ ${funcName} loaded successfully`, 'success');
                    loadedCount++;
                } else {
                    showResult(container, `‚ùå ${funcName} not found`, 'error');
                }
            });
            
            if (loadedCount === requiredFunctions.length) {
                showResult(container, `üéâ All ${loadedCount} functions loaded successfully!`, 'success');
                log('Script loading test: SUCCESS');
            } else {
                showResult(container, `‚ö†Ô∏è Only ${loadedCount}/${requiredFunctions.length} functions loaded`, 'warning');
                log('Script loading test: PARTIAL');
            }
        }
        
        function testAlgorithmFunctionality() {
            log('Starting algorithm functionality test...');
            const container = 'algorithm-test-results';
            
            // Clear previous results
            document.getElementById(container).innerHTML = '';
            
            try {
                // Test basic configuration
                const testConfig = {
                    totalGameSeconds: 2400, // 40 minutes
                    rotatingPlayers: ['P1', 'P2', 'P3', 'P4', 'P5', 'P6', 'P7', 'P8'],
                    playersOnCourt: 5,
                    maxSubsPerChange: 2,
                    exemptPlayers: []
                };
                
                log('Testing dynamic algorithm with basketball configuration...');
                
                const result = calculateDynamicPerfectPlan(testConfig);
                
                if (result.error) {
                    showResult(container, `‚ùå Algorithm returned error: ${result.error}`, 'error');
                    log('Algorithm test: FAILED - ' + result.error);
                    return;
                }
                
                // Verify result structure
                if (result.substitutionPlan && result.verification) {
                    showResult(container, `‚úÖ Algorithm returned valid result structure`, 'success');
                    showResult(container, `üìä Generated ${result.substitutionPlan.length} substitutions`, 'info');
                    showResult(container, `üéØ Projected variance: ${result.verification.variance}s`, 'info');
                    showResult(container, `‚è±Ô∏è Calculation time: ${result.calculationTime}ms`, 'info');
                    showResult(container, `üßÆ Algorithm used: ${result.algorithm}`, 'info');
                    
                    if (result.verification.variance <= 60) {
                        showResult(container, `üéâ Excellent balance achieved (‚â§60s variance)!`, 'success');
                    } else if (result.verification.variance <= 120) {
                        showResult(container, `‚úÖ Good balance achieved (‚â§120s variance)`, 'success');
                    } else {
                        showResult(container, `‚ö†Ô∏è Balance could be improved (${result.verification.variance}s variance)`, 'warning');
                    }
                    
                    log('Algorithm test: SUCCESS');
                } else {
                    showResult(container, `‚ùå Algorithm returned invalid result structure`, 'error');
                    log('Algorithm test: FAILED - Invalid structure');
                }
                
            } catch (error) {
                showResult(container, `‚ùå Algorithm test failed: ${error.message}`, 'error');
                log('Algorithm test: ERROR - ' + error.message);
            }
        }
        
        function runAlgorithmComparison() {
            log('Starting algorithm comparison test...');
            const container = 'comparison-results';
            
            // Clear previous results
            document.getElementById(container).innerHTML = '';
            
            try {
                const players = ['P1', 'P2', 'P3', 'P4', 'P5', 'P6', 'P7', 'P8'];
                const playersOnField = 5;
                const subsPerChange = 2;
                
                log('Comparing Dynamic vs Original algorithm...');
                
                // Test original algorithm (should fall back to patterns/heuristics)
                const originalResult = calculateOptimalLineups(players, playersOnField, subsPerChange);
                
                // Test with dynamic disabled to force original
                const originalForced = calculateOptimalLineupsEnhanced(players, playersOnField, subsPerChange);
                
                const comparisonDiv = document.createElement('div');
                comparisonDiv.className = 'algorithm-comparison';
                
                // Dynamic result
                const dynamicDiv = document.createElement('div');
                dynamicDiv.className = 'algorithm-result dynamic-result';
                dynamicDiv.innerHTML = `
                    <h3>üöÄ Dynamic Algorithm</h3>
                    <p><strong>Method:</strong> ${originalResult.method || 'Dynamic Perfect'}</p>
                    <p><strong>Lineups Generated:</strong> ${originalResult.numLineups || originalResult.lineups?.length || 0}</p>
                    <p><strong>Variance:</strong> ${originalResult.variance || 'Not calculated'}s</p>
                    <p><strong>Calculation Time:</strong> ${originalResult.calculationTime || 'N/A'}ms</p>
                `;
                
                // Original result
                const originalDiv = document.createElement('div');
                originalDiv.className = 'algorithm-result original-result';
                originalDiv.innerHTML = `
                    <h3>üîß Original Algorithm</h3>
                    <p><strong>Method:</strong> ${originalForced.method || 'Pattern-based'}</p>
                    <p><strong>Lineups Generated:</strong> ${originalForced.numLineups || originalForced.lineups?.length || 0}</p>
                    <p><strong>Variance:</strong> ${originalForced.variance || 'Not calculated'}s</p>
                    <p><strong>Calculation Time:</strong> ${originalForced.calculationTime || '<50'}ms</p>
                `;
                
                comparisonDiv.appendChild(dynamicDiv);
                comparisonDiv.appendChild(originalDiv);
                document.getElementById(container).appendChild(comparisonDiv);
                
                // Analysis
                if (originalResult.method === 'DYNAMIC_PERFECT') {
                    showResult(container, `üéâ Dynamic algorithm successfully used!`, 'success');
                } else {
                    showResult(container, `‚ÑπÔ∏è Fallback algorithm used: ${originalResult.method}`, 'info');
                }
                
                log('Algorithm comparison: COMPLETED');
                
            } catch (error) {
                showResult(container, `‚ùå Comparison failed: ${error.message}`, 'error');
                log('Algorithm comparison: ERROR - ' + error.message);
            }
        }
        
        function testRecalculationCapability() {
            log('Starting recalculation capability test...');
            const container = 'recalculation-results';
            
            // Clear previous results
            document.getElementById(container).innerHTML = '';
            
            try {
                // Mock some game state
                window.currentGameSeconds = 600; // 10 minutes into game
                window.optimizedSubPlan = [];
                window.optimizedSubSchedule = [];
                
                // Mock required functions
                if (typeof recalculateRemainingAutoSubTimes === 'undefined') {
                    window.recalculateRemainingAutoSubTimes = function() {
                        log('Mock: recalculateRemainingAutoSubTimes called');
                    };
                }
                
                if (typeof updateDisplay === 'undefined') {
                    window.updateDisplay = function() {
                        log('Mock: updateDisplay called');
                    };
                }
                
                if (typeof showStatusMessage === 'undefined') {
                    window.showStatusMessage = function(message, duration) {
                        log(`Mock: showStatusMessage - ${message} (${duration}ms)`);
                    };
                }
                
                log('Testing recalculation function...');
                
                if (typeof triggerPerfectBalanceRecalculation === 'function') {
                    const success = triggerPerfectBalanceRecalculation('Integration test');
                    
                    if (success) {
                        showResult(container, `‚úÖ Recalculation triggered successfully`, 'success');
                    } else {
                        showResult(container, `‚ö†Ô∏è Recalculation completed but returned false`, 'warning');
                    }
                    
                    showResult(container, `üîÑ Unlimited recalculation capability: AVAILABLE`, 'success');
                    log('Recalculation test: SUCCESS');
                } else {
                    showResult(container, `‚ùå Recalculation function not available`, 'error');
                    log('Recalculation test: FAILED - Function not found');
                }
                
            } catch (error) {
                showResult(container, `‚ùå Recalculation test failed: ${error.message}`, 'error');
                log('Recalculation test: ERROR - ' + error.message);
            }
        }
        
        // Auto-run basic tests on page load
        window.addEventListener('load', function() {
            log('Dynamic Algorithm Integration Test - Starting...');
            setTimeout(() => {
                testScriptLoading();
                setTimeout(() => {
                    testAlgorithmFunctionality();
                }, 1000);
            }, 500);
        });
    </script>
</body>
</html>