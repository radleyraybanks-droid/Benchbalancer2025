<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bench Balancer - Pro Dashboard</title>

    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Supabase Initialization -->
    <script src="config/env.js"></script>
    <script type="module" src="config/simple-supabase.js"></script>
    <script type="module">
        // Initialize auth after module loads and wait for it to be ready
        import { initAuth } from './config/simple-supabase.js';

        (async () => {
            await initAuth();
            console.log('‚úÖ Dashboard: Supabase initialization complete');
        })();
    </script>

    <!-- Dashboard Specific Styles -->
    <style>
        /* ---------- Typeface Imports ---------- */
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Russo+One&family=Roboto:wght@400;500;700;900&family=Roboto+Mono:wght@500;700&display=swap');

        /* ---------- Theme Tokens ---------- */
        :root {
            --bg-900: #04070d;
            --bg-880: #08101a;
            --bg-850: #0e1625;
            --accent-cyan: #00ffe0;
            --accent-blue: #73a7ff;
            --text-primary: #f5fbff;
            --text-secondary: #9fb7d6;
            --neon-cyan: #00ffe0;
            /* Alias for compatibility */
            --bg-dark: #08101a;
        }

        /* Light Mode Overrides */
        :root[data-theme="light"] {
            --bg-900: #f0f4f8;
            --bg-880: #ffffff;
            --bg-850: #e2e8f0;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --accent-cyan: #00b5ad;
            /* Darker cyan for light mode */
            --bg-dark: #f0f4f8;
        }

        /* DROPDOWN MENUS */
        .menu-dropdown {
            position: absolute;
            top: 60px;
            right: 20px;
            background: #111;
            border: 1px solid var(--accent-cyan);
            border-radius: 12px;
            width: 220px;
            display: none;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        .menu-dropdown.active {
            display: flex;
        }

        .menu-item {
            padding: 14px 16px;
            color: #fff;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: rgba(0, 255, 224, 0.1);
            color: var(--accent-cyan);
        }

        .menu-item.danger {
            color: #ff5252;
        }

        .menu-item.danger:hover {
            background: rgba(255, 82, 82, 0.1);
        }

        .menu-icon {
            font-size: 20px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background: #111820;
            /* Dark bg */
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        #appHeader {
            padding: 18px 24px;
            background: linear-gradient(180deg, rgba(8, 16, 26, 0.98) 0%, rgba(8, 16, 26, 0.92) 100%);
            border-bottom: 2px solid rgba(0, 255, 224, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 75px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);
        }

        .header-brand {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .header-brand img {
            height: 50px !important;
            width: auto !important;
            filter: drop-shadow(0 3px 8px rgba(0, 255, 224, 0.5));
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 18px;
            justify-content: flex-end;
        }

        .upgrade-btn {
            padding: 0;
            border: none;
            background: none;
            cursor: pointer;
            height: 42px !important;
            width: auto !important;
            opacity: 0.95;
            transition: opacity 0.3s, transform 0.3s;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.4));
        }

        .upgrade-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .header-icon {
            height: 44px !important;
            width: auto !important;
            cursor: pointer;
            transition: transform 0.3s ease, filter 0.3s ease;
            filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.4));
        }

        .header-icon:hover {
            transform: scale(1.15);
            filter: drop-shadow(0 4px 10px rgba(0, 255, 224, 0.6));
        }

        /* Dashboard Container */
        .dashboard-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Hero Section */
        .dashboard-hero {
            background: #000;
            border: 2px solid var(--accent-cyan);
            border-radius: 20px;
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 160px;
        }

        .dashboard-hero:hover {
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(0, 255, 224, 0.4);
        }

        .hero-left {
            z-index: 2;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .hero-title {
            font-family: 'Russo One', sans-serif;
            color: #fff;
            font-size: 28px;
            text-transform: uppercase;
        }

        .play-button {
            width: 70px;
            height: 70px;
            border: 4px solid #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
        }

        .play-icon {
            width: 0;
            height: 0;
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-left: 26px solid #fff;
            margin-left: 6px;
            /* Optical center */
        }

        .hero-image {
            position: absolute;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
            height: 140%;
            width: auto;
            opacity: 0.9;
            z-index: 1;
        }

        /* Grid Section */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .dashboard-tile {
            background: #000;
            border: 1px solid var(--accent-cyan);
            border-radius: 16px;
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 12px;
            transition: all 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: #fff;
            min-height: 160px;
            position: relative;
            overflow: hidden;
        }

        .dashboard-tile:hover {
            background: rgba(0, 255, 224, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 224, 0.2);
        }

        .tile-icon {
            margin-bottom: 4px;
        }

        .tile-icon svg {
            width: 48px;
            height: 48px;
            fill: none;
            stroke: #fff;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .tile-title {
            font-family: 'Russo One', sans-serif;
            font-size: 18px;
            text-transform: uppercase;
            line-height: 1.1;
        }

        .tile-subtitle {
            font-family: 'Roboto', sans-serif;
            font-size: 13px;
            color: #ccc;
            font-weight: 400;
        }

        /* Footer Nav */
        .footer-nav {
            margin-top: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 0;
            display: flex;
            justify-content: space-around;
            background: #08101a;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            color: #666;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--accent-cyan);
        }

        .nav-icon {
            font-size: 20px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .nav-icon-img {
            width: 24px;
            height: 24px;
            object-fit: contain;
            opacity: 0.5;
            transition: opacity 0.2s, filter 0.2s;
        }

        .nav-item.active .nav-icon-img {
            opacity: 1;
            filter: drop-shadow(0 0 4px var(--accent-cyan));
        }

        /* Starting Team Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(145deg, #1a202c, #2d3748);
            border: 2px solid var(--accent-cyan);
            border-radius: 24px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
        }

        .modal-title {
            font-family: 'Russo One', sans-serif;
            font-size: 28px;
            text-align: center;
            margin: 0;
            color: #fff;
            text-transform: uppercase;
        }

        .instruction-bar {
            background: var(--accent-cyan);
            color: #000;
            font-weight: bold;
            text-align: center;
            padding: 4px 0;
            border-radius: 999px;
            font-size: 12px;
            text-transform: uppercase;
        }

        .lists-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .list-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .list-header {
            text-align: center;
            font-family: 'Russo One', sans-serif;
            font-size: 18px;
            color: #fff;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .player-slots {
            min-height: 200px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .player-pill {
            background: var(--accent-cyan);
            color: #1a202c;
            /* Dark text on Cyan */
            font-family: 'Russo One', sans-serif;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 999px;
            text-align: center;
            cursor: grab;
            transition: transform 0.1s;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .player-pill:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        /* Edit icon in corner */
        .modal-edit-icon {
            position: absolute;
            bottom: 24px;
            right: 24px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s, transform 0.2s;
        }

        .modal-edit-icon:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* UPGRADE MODAL SPECIFIC */
        #upgradeModal .modal-content {
            border: 2px solid #fff;
            /* White border per design? Or Cyan? Design image shows white/cyan mix. Stick to Cyan for brand or white for pop. Image looks white-ish border on modal. Let's go Cyan to match brand. */
            border: 3px solid var(--accent-cyan);
            background: #000;
            max-width: 450px;
            text-align: center;
        }

        .upgrade-title {
            font-family: 'Russo One', sans-serif;
            font-size: 42px;
            line-height: 1.1;
            color: #fff;
            margin-bottom: 24px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .upgrade-list {
            text-align: left;
            color: #fff;
            font-family: 'Russo One', sans-serif;
            font-size: 18px;
            list-style: none;
            padding: 0;
            margin: 0 auto 32px auto;
            display: inline-block;
        }

        .upgrade-list li {
            margin-bottom: 12px;
            position: relative;
            padding-left: 24px;
        }

        .upgrade-list li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: #fff;
        }

        .purchase-btn {
            background: var(--accent-cyan);
            color: #000;
            font-family: 'Russo One', sans-serif;
            font-size: 28px;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            width: 100%;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
        }

        .purchase-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--accent-cyan);
        }

        .cancel-text {
            color: #aaa;
            font-size: 12px;
            margin-top: 12px;
            font-family: 'Roboto', sans-serif;
        }

        /* PRICING STEPS */
        .pricing-option {
            border: 3px solid var(--accent-cyan);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            background: rgba(0, 255, 224, 0.05);
        }

        .pricing-option:hover {
            background: rgba(0, 255, 224, 0.15);
            transform: scale(1.02);
        }

        .pricing-price {
            font-family: 'Russo One', sans-serif;
            font-size: 32px;
            color: #fff;
            margin-bottom: 4px;
        }

        .pricing-period {
            font-family: 'Roboto', sans-serif;
            font-size: 12px;
            color: #ccc;
            text-transform: uppercase;
            font-weight: bold;
        }

        .separator-or {
            font-family: 'Russo One', sans-serif;
            font-size: 24px;
            color: #fff;
            margin: 12px 0;
            text-transform: uppercase;
        }

        /* Game Mode Modal Specifics */
        .game-mode-content {
            background: linear-gradient(145deg, #0f151f, #1a2332);
            border: 2px solid var(--accent-cyan);
            border-radius: 24px;
            padding: 32px;
            width: 95%;
            max-width: 650px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            position: relative;
            box-shadow: 0 0 50px rgba(0, 255, 224, 0.15);
        }

        .mode-selection-container {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 20px;
            position: relative;
        }

        .mode-card {
            flex: 1;
            border: 3px solid var(--accent-cyan);
            border-radius: 20px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(0, 0, 0, 0.3);
            text-align: center;
            min-height: 200px;
        }

        .mode-card:hover {
            transform: scale(1.03);
            background: rgba(0, 255, 224, 0.05);
            box-shadow: 0 0 20px rgba(0, 255, 224, 0.2);
        }

        .mode-title {
            font-family: 'Russo One', sans-serif;
            font-size: 22px;
            color: #fff;
            text-transform: uppercase;
        }

        .mode-desc {
            font-family: 'Roboto', sans-serif;
            font-size: 13px;
            color: #ccc;
            line-height: 1.4;
            max-width: 220px;
        }

        .or-divider {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #fff;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Russo One', sans-serif;
            font-size: 14px;
            z-index: 10;
        }

        .close-modal-x {
            position: absolute;
            top: 16px;
            right: 20px;
            font-size: 28px;
            color: var(--accent-cyan);
            cursor: pointer;
            transition: opacity 0.2s;
            font-family: sans-serif;
            font-weight: bold;
        }

        .close-modal-x:hover {
            opacity: 0.7;
        }

        @media (max-width: 600px) {
            .mode-selection-container {
                flex-direction: column;
            }

            .or-divider {
                position: relative;
                top: auto;
                left: auto;
                transform: none;
                margin: -10px auto;
            }
        }
    </style>
</head>

<body>

    <header id="appHeader">
        <div class="header-brand">
            <img src="assets/bench-balancer-logo-v2.png" alt="Bench Balancer">
        </div>
        <div class="header-actions">
            <!-- Updated Onclick -->
            <!-- Updated Header Actions -->
            <img src="assets/btn-upgrade.png" class="upgrade-btn" alt="Upgrade" onclick="openUpgradeModal()">

            <!-- HELP ICON -->
            <div style="position:relative;">
                <img src="assets/icon-help.png" alt="Help" onclick="toggleMenu('helpMenu')" class="header-icon">
                <!-- Help Dropdown -->
                <div id="helpMenu" class="menu-dropdown" style="right: -40px; width: 260px;">
                    <div class="menu-item" onclick="showHelpModal('quickstart')">
                        <span>üöÄ</span> Quick Start Guide
                    </div>
                    <div class="menu-item" onclick="showHelpModal('scoring')">
                        <span>üî¢</span> How Scoring Works
                    </div>
                    <div class="menu-item" onclick="window.location.href='mailto:support@benchbalancer.com'">
                        <span>‚úâÔ∏è</span> Contact Support
                    </div>
                    <div class="menu-item" onclick="window.location.href='privacy.html'">
                        <span>üîí</span> Privacy Policy
                    </div>
                </div>
            </div>

            <!-- SETTINGS ICON -->
            <div style="position:relative;">
                <img src="assets/icon-settings.png" alt="Settings" onclick="toggleMenu('settingsMenu')" class="header-icon">
                <!-- Settings Dropdown -->
                <div id="settingsMenu" class="menu-dropdown">
                    <div class="menu-item" onclick="toggleTheme()">
                        <span>üåì</span> Appearance (Toggle)
                    </div>
                    <div class="menu-item" onclick="openProfileModal()">
                        <span>üë§</span> Edit Profile
                    </div>
                    <div class="menu-item danger" onclick="handleSignOut()">
                        <span>üö™</span> Log Out
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard-container">

        <!-- Hero: Start Game -->
        <!-- Links to game setup/engine page -->
        <!-- Hero: Start Game -->
        <div class="dashboard-hero" onclick="openGameModeModal()">
            <div class="hero-left">
                <div class="hero-title">START GAME</div>
                <div class="play-button">
                    <div class="play-icon"></div>
                </div>
            </div>
            <!-- Using the found asset -->
            <img src="assets/flaming-basketball.png" class="hero-image" alt="Flaming Ball">
        </div>

        <!-- Tile Grid -->
        <div class="dashboard-grid">

            <!-- YOUR TEAM -->
            <a href="pro-squad-management.html" class="dashboard-tile">
                <div class="tile-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="tile-title">YOUR TEAM</div>
                <div class="tile-subtitle">add players</div>
            </a>

            <!-- PLAYER STATS -->
            <a href="player-stats.html" class="dashboard-tile">
                <div class="tile-icon">
                    <svg viewBox="0 0 24 24">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                </div>
                <div class="tile-title">PLAYER STATS</div>
                <div class="tile-subtitle">view analytics</div>
            </a>

            <!-- STARTING TEAM -->
            <a href="#" class="dashboard-tile" onclick="openStartingTeamModal(); return false;">
                <div class="tile-icon">
                    <svg viewBox="0 0 24 24">
                        <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                        <polyline points="2 17 12 22 22 17"></polyline>
                        <polyline points="2 12 12 17 22 12"></polyline>
                    </svg>
                </div>
                <div class="tile-title">STARTING TEAM</div>
                <div class="tile-subtitle">set lineup</div>
            </a>

            <!-- SCHEDULE -->
            <a href="schedule-management.html" class="dashboard-tile">
                <div class="tile-icon">
                    <svg viewBox="0 0 24 24">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
                <div class="tile-title">SCHEDULE</div>
                <div class="tile-subtitle">manage games</div>
            </a>

            <!-- MATCH HISTORY -->
            <a href="match-history.html" class="dashboard-tile">
                <div class="tile-icon">
                    <svg viewBox="0 0 24 24">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                </div>
                <div class="tile-title">MATCH HISTORY</div>
                <div class="tile-subtitle">view past games</div>
            </a>

            <!-- TEAM ANALYTICS -->
            <a href="team-analytics.html" class="dashboard-tile">
                <div class="tile-icon">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                        </path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                </div>
                <div class="tile-title">TEAM ANALYTICS</div>
                <div class="tile-subtitle">reports & trends</div>
            </a>

        </div>
    </div>

    <nav class="footer-nav">
        <a href="#" class="nav-item active">
            <img src="assets/icon-home.png" class="nav-icon-img" alt="Home">
            <span class="nav-label">HOME</span>
        </a>
        <a href="pro-squad-management.html" class="nav-item">
            <img src="assets/icon-teams.png" class="nav-icon-img" alt="Teams">
            <span class="nav-label">TEAMS</span>
        </a>
        <a href="#" class="nav-item" onclick="openGameModeModal(); return false;">
            <img src="assets/icon-start.png" class="nav-icon-img" alt="Start">
            <span class="nav-label">START</span>
        </a>
        <a href="#" class="nav-item">
            <img src="assets/icon-stats.png" class="nav-icon-img" alt="Stats">
            <span class="nav-label">STATS</span>
        </a>
        <a href="#" class="nav-item">
            <img src="assets/icon-coaches.png" class="nav-icon-img" alt="Coaches">
            <span class="nav-label">COACHES</span>
        </a>
    </nav>

    <!-- Game Mode Modal -->
    <div class="modal-overlay" id="gameModeModal" onclick="closeGameModeModal(event)">
        <div class="game-mode-content" onclick="event.stopPropagation()">
            <img src="assets/icon-close.png" class="close-modal-x" style="width:28px; height:28px; object-fit:contain;"
                onclick="closeGameModeModal()">
            <h2 class="modal-title" style="font-size: 36px;">GAME MODE</h2>

            <div class="mode-selection-container">
                <div class="mode-card" onclick="window.location.href='schedule-management.html'">
                    <div class="mode-title">Play Competitive Game</div>
                    <div class="mode-desc">Stats will be recorded for this game and will use your next scheduled game
                    </div>
                </div>

                <div class="or-divider">OR</div>

                <div class="mode-card" style="border-color: var(--accent-blue);" onclick="handlePracticeGameClick()">
                    <div class="mode-title">Play Practice Game</div>
                    <div class="mode-desc">No stats are recorded, this will not use a scheduled game</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Starting Team Modal -->
    <div class="modal-overlay" id="startingTeamModal" onclick="closeStartingTeamModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="modal-title">STARTING TEAM</h2>
            <div class="instruction-bar">Drag & Drop players</div>

            <div class="lists-container" style="grid-template-columns: repeat(3, 1fr);">
                <!-- Starting Column -->
                <div class="list-column">
                    <div class="list-header">STARTING</div>
                    <div class="player-slots" id="startingPlayersList" ondragover="allowDrop(event)"
                        ondrop="drop(event, 'starting')">
                        <!-- Pills injected JS -->
                    </div>
                </div>

                <!-- Bench Column -->
                <div class="list-column">
                    <div class="list-header">BENCH</div>
                    <div class="player-slots" id="benchPlayersList" ondragover="allowDrop(event)"
                        ondrop="drop(event, 'bench')">
                        <!-- Pills injected JS -->
                    </div>
                </div>

                <!-- Not Available Column -->
                <div class="list-column">
                    <div class="list-header"
                        style="background: rgba(255, 95, 109, 0.2); border-color: rgba(255, 95, 109, 0.4);">NOT
                        AVAILABLE</div>
                    <div class="player-slots" id="unavailablePlayersList" ondragover="allowDrop(event)"
                        ondrop="drop(event, 'unavailable')" style="border-color: rgba(255, 95, 109, 0.3);">
                        <!-- Pills injected JS -->
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <button id="saveLineupBtn" onclick="saveStartingLineupToSupabase()" style="
                    background: var(--accent-cyan);
                    color: #000;
                    border: none;
                    padding: 14px 24px;
                    border-radius: 12px;
                    font-family: 'Russo One', sans-serif;
                    font-size: 16px;
                    text-transform: uppercase;
                    cursor: pointer;
                    margin: 24px auto 16px auto;
                    display: block;
                    width: calc(100% - 48px);
                    max-width: 280px;
                    transition: all 0.2s;
                    box-shadow: 0 4px 12px rgba(0, 255, 224, 0.3);
                "
                onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(0, 255, 224, 0.5)'"
                onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0, 255, 224, 0.3)'">
                üíæ Save Starting Lineup
            </button>

            <!-- Edit Icon (visual only per design, or could link to team manager) -->
            <img src="assets/icon-edit.png" class="modal-edit-icon" alt="Edit team"
                onclick="window.location.href='pro-squad-management.html'">
        </div>
    </div>

    <!-- Logic -->

    <!-- Help Content Modal -->
    <div class="modal-overlay" id="helpContentModal" onclick="this.classList.remove('active')">
        <div class="modal-content" onclick="event.stopPropagation()"
            style="background:#111; border:1px solid var(--accent-cyan); color:#fff; max-width:500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h2 id="helpModalTitle" style="margin:0; font-family:'Russo One'; color:var(--accent-cyan);">Help</h2>
                <img src="assets/icon-close.png" style="width:24px; height:24px; cursor:pointer;"
                    onclick="document.getElementById('helpContentModal').classList.remove('active')">
            </div>
            <div id="helpModalBody" style="font-size:14px; line-height:1.6; color:#ddd;">
                <!-- Content -->
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal-overlay" id="editProfileModal" onclick="this.classList.remove('active')">
        <div class="modal-content" onclick="event.stopPropagation()"
            style="background:#111; border:1px solid var(--accent-cyan); color:#fff; max-width:400px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h2 style="margin:0; font-family:'Russo One'; color:var(--accent-cyan);">Edit Profile</h2>
                <img src="assets/icon-close.png" style="width:24px; height:24px; cursor:pointer;"
                    onclick="document.getElementById('editProfileModal').classList.remove('active')">
            </div>

            <div style="margin-bottom:16px;">
                <label style="display:block; color:#aaa; font-size:12px; margin-bottom:4px;">Coach Name</label>
                <input type="text" id="profileCoachName"
                    style="width:100%; padding:10px; background:#222; border:1px solid #444; color:#fff; border-radius:6px;"
                    value="Coach">
            </div>
            <div style="margin-bottom:16px;">
                <label style="display:block; color:#aaa; font-size:12px; margin-bottom:4px;">Team Name</label>
                <input type="text" id="profileTeamName"
                    style="width:100%; padding:10px; background:#222; border:1px solid #444; color:#fff; border-radius:6px;"
                    value="My Team">
            </div>
            <button onclick="saveProfile()"
                style="width:100%; padding:12px; background:var(--accent-cyan); color:#000; font-weight:bold; border:none; border-radius:6px; cursor:pointer;">SAVE
                CHANGES</button>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // --- Menu Logic ---
        function toggleMenu(menuId) {
            const menu = document.getElementById(menuId);
            const isActive = menu.classList.contains('active');

            // Close all
            document.querySelectorAll('.menu-dropdown').forEach(el => el.classList.remove('active'));

            // Toggle target
            if (!isActive) menu.classList.add('active');
        }

        // Close on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.header-actions')) {
                document.querySelectorAll('.menu-dropdown').forEach(el => el.classList.remove('active'));
            }
        });

        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            if (current === 'light') {
                html.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
            } else {
                html.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
            toggleMenu('settingsMenu');
        }

        async function handleSignOut() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    if (window.benchBalancerSupabase) {
                        await window.benchBalancerSupabase.auth.signOut();
                    }
                    localStorage.removeItem('sb-pomcalscfnwsqlscunxf-auth-token');
                    window.location.reload();
                } catch (e) {
                    console.error('Logout error', e);
                    window.location.reload();
                }
            }
        }

        function showHelpModal(type) {
            const modal = document.getElementById('helpContentModal');
            const title = document.getElementById('helpModalTitle');
            const body = document.getElementById('helpModalBody');

            if (type === 'quickstart') {
                title.innerText = "Quick Start Guide";
                body.innerHTML = `
                    <div style="margin-bottom:12px; font-weight:bold; color:var(--accent-cyan);">1. Create Your Team</div>
                    <div style="margin-bottom:12px;">Go to "YOUR TEAM" to add players, numbers, and details.</div>
                    
                    <div style="margin-bottom:12px; font-weight:bold; color:var(--accent-cyan);">2. Start a Game</div>
                    <div style="margin-bottom:12px;">Tap "START GAME" for Practice or Competitive modes.</div>
                    
                    <div style="margin-bottom:12px; font-weight:bold; color:var(--accent-cyan);">3. Rotations</div>
                    <div style="margin-bottom:12px;">Follow the automated alerts to keep playing time fair.</div>
                 `;
            } else if (type === 'scoring') {
                title.innerText = "Variance Explained";
                body.innerHTML = `
                    <div style="margin-bottom:12px;">"Variance" is the time difference between the player with the MOST participation and the LEAST.</div>
                    <div style="color:#00e676; font-weight:bold;">0-60s: Perfect Balance</div>
                    <div style="color:#ffb74d; font-weight:bold;">60s-120s: Good</div>
                    <div style="color:#ff5252; font-weight:bold;">120s+: Uneven</div>
                `;
            }

            document.querySelectorAll('.menu-dropdown').forEach(el => el.classList.remove('active'));
            modal.classList.add('active');
        }

        // Profile Logic
        function openProfileModal() {
            const savedProfile = localStorage.getItem('benchbalancer_profile');
            if (savedProfile) {
                const p = JSON.parse(savedProfile);
                document.getElementById('profileCoachName').value = p.coachName || 'Coach';
                document.getElementById('profileTeamName').value = p.teamName || 'My Team';
            }
            document.getElementById('editProfileModal').classList.add('active');
            toggleMenu('settingsMenu');
        }

        function saveProfile() {
            const coachName = document.getElementById('profileCoachName').value;
            const teamName = document.getElementById('profileTeamName').value;
            const profile = { coachName, teamName };
            localStorage.setItem('benchbalancer_profile', JSON.stringify(profile));
            alert('Profile saved!');
            document.getElementById('editProfileModal').classList.remove('active');
        }

        // Initialize Theme
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        });
        // State
        let allPlayers = [];
        let startingIds = [];
        let unavailableIds = []; // NEW: Track unavailable players

        function openGameModeModal() {
            document.getElementById('gameModeModal').classList.add('active');
        }

        function closeGameModeModal(e) {
            if (e) e.stopPropagation();
            document.getElementById('gameModeModal').classList.remove('active');
        }

        function openStartingTeamModal() {
            document.getElementById('startingTeamModal').classList.add('active');
            loadStartingTeamDataWithCloud();
        }

        function closeStartingTeamModal(e) {
            if (e) e.stopPropagation(); // prevented by inline
            document.getElementById('startingTeamModal').classList.remove('active');
        }

        function loadStartingTeamData() {
            // Get data
            const squadJson = localStorage.getItem('benchbalancer_pro_squad');
            allPlayers = squadJson ? JSON.parse(squadJson) : [];

            const startingJson = localStorage.getItem('benchbalancer_starting_lineup');
            startingIds = startingJson ? JSON.parse(startingJson) : [];

            const unavailableJson = localStorage.getItem('benchbalancer_unavailable_players');
            unavailableIds = unavailableJson ? JSON.parse(unavailableJson) : [];

            renderLists();
        }

        function renderLists() {
            const startingList = document.getElementById('startingPlayersList');
            const benchList = document.getElementById('benchPlayersList');
            const unavailableList = document.getElementById('unavailablePlayersList');

            startingList.innerHTML = '';
            benchList.innerHTML = '';
            unavailableList.innerHTML = '';

            allPlayers.forEach(p => {
                const pill = createPlayerPill(p);

                if (unavailableIds.includes(p.id)) {
                    // Unavailable zone (red styling)
                    pill.style.background = 'rgba(255, 95, 109, 0.8)';
                    pill.style.color = '#fff';
                    unavailableList.appendChild(pill);
                } else if (startingIds.includes(p.id)) {
                    // Starting zone
                    startingList.appendChild(pill);
                } else {
                    // Bench zone
                    benchList.appendChild(pill);
                }
            });
        }

        function createPlayerPill(player) {
            const div = document.createElement('div');
            div.className = 'player-pill';
            div.draggable = true;
            div.innerText = player.name ? player.name.split(' ')[0].toUpperCase() : 'UNKNOWN'; // First name caps
            div.id = 'pill_' + player.id;
            div.dataset.playerId = player.id;

            div.ondragstart = drag;

            return div;
        }

        // Drag handlers
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.dataset.playerId);
        }

        function drop(ev, targetType) {
            ev.preventDefault();
            const playerId = ev.dataTransfer.getData("text");
            // Find where to move
            movePlayerTo(playerId, targetType);
        }

        function movePlayerTo(playerId, targetType) {
            // Remove from all arrays first
            startingIds = startingIds.filter(id => id !== playerId);
            unavailableIds = unavailableIds.filter(id => id !== playerId);

            // Add to target array
            if (targetType === 'starting') {
                startingIds.push(playerId);
            } else if (targetType === 'unavailable') {
                unavailableIds.push(playerId);
            }
            // If 'bench', just leave it out of both arrays

            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('benchbalancer_starting_lineup', JSON.stringify(startingIds));
            localStorage.setItem('benchbalancer_unavailable_players', JSON.stringify(unavailableIds));
            renderLists();
        }

        /**
         * Save starting lineup to Supabase for persistent storage
         */
        async function saveStartingLineupToSupabase() {
            const btn = document.getElementById('saveLineupBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'üíæ Connecting...';
            btn.disabled = true;

            try {
                // Wait for Supabase to initialize (if it hasn't already)
                if (window.supabaseReady) {
                    await window.supabaseReady;
                }

                if (!window.benchBalancerSupabase) {
                    alert('Not connected to database. Lineup saved locally only.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                btn.innerHTML = 'üíæ Saving...';

                // Get current user
                const { data: { user }, error: authError } = await window.benchBalancerSupabase.auth.getUser();

                if (authError || !user) {
                    alert('Please sign in to save your lineup to the cloud');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                // Get starting, bench, and unavailable player data
                const startingPlayers = [];
                const benchPlayers = [];
                const unavailablePlayers = [];

                allPlayers.forEach(p => {
                    const playerData = {
                        id: p.id,
                        name: p.name,
                        jersey: p.jersey || null
                    };

                    if (unavailableIds.includes(p.id)) {
                        unavailablePlayers.push(playerData);
                    } else if (startingIds.includes(p.id)) {
                        startingPlayers.push(playerData);
                    } else {
                        benchPlayers.push(playerData);
                    }
                });

                // Upsert to Supabase (insert or update)
                const { error } = await window.benchBalancerSupabase
                    .from('default_lineups')
                    .upsert({
                        user_id: user.id,
                        sport: 'basketball',
                        starting_players: startingPlayers,
                        bench_players: benchPlayers,
                        unavailable_players: unavailablePlayers  // NEW
                    }, {
                        onConflict: 'user_id'
                    });

                if (error) {
                    console.error('Save error:', error);
                    alert('Failed to save lineup: ' + error.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                // Success!
                btn.innerHTML = '‚úÖ Saved!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Unexpected error saving lineup:', error);
                alert('Error saving lineup. Please try again.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        /**
         * Load starting lineup from Supabase
         */
        async function loadStartingLineupFromSupabase() {
            // Wait for Supabase to be ready first
            if (window.supabaseReady) {
                try {
                    await window.supabaseReady;
                } catch (e) {
                    console.warn('Supabase init failed');
                }
            }

            if (!window.benchBalancerSupabase) {
                console.log('Supabase not available, using local storage');
                return false;
            }

            try {
                const { data: { user } } = await window.benchBalancerSupabase.auth.getUser();

                if (!user) {
                    console.log('User not authenticated');
                    return false;
                }

                const { data, error } = await window.benchBalancerSupabase
                    .from('default_lineups')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('sport', 'basketball')
                    .single();

                if (error || !data) {
                    console.log('No saved lineup found');
                    return false;
                }

                // Load the saved lineup
                const savedStartingIds = (data.starting_players || []).map(p => p.id);
                const savedUnavailableIds = (data.unavailable_players || []).map(p => p.id);

                // Update local state
                startingIds = savedStartingIds;
                unavailableIds = savedUnavailableIds;
                localStorage.setItem('benchbalancer_starting_lineup', JSON.stringify(startingIds));
                localStorage.setItem('benchbalancer_unavailable_players', JSON.stringify(unavailableIds));

                console.log('‚úÖ Loaded starting lineup from Supabase');
                return true;

            } catch (error) {
                console.error('Error loading lineup from Supabase:', error);
                return false;
            }
        }

        // Update loadStartingTeamData to try Supabase first
        async function loadStartingTeamDataWithCloud() {
            // Get squad data
            const squadJson = localStorage.getItem('benchbalancer_pro_squad');
            allPlayers = squadJson ? JSON.parse(squadJson) : [];

            // Try loading from Supabase first
            const loadedFromCloud = await loadStartingLineupFromSupabase();

            if (!loadedFromCloud) {
                // Fall back to local storage
                const startingJson = localStorage.getItem('benchbalancer_starting_lineup');
                startingIds = startingJson ? JSON.parse(startingJson) : [];
            }

            renderLists();
        }

        // Update openStartingTeamModal to use cloud loading
        function openStartingTeamModal() {
            document.getElementById('startingTeamModal').classList.add('active');
            loadStartingTeamDataWithCloud(); // Changed from loadStartingTeamData
        }
    </script>

    <!-- Upgrade Modal -->
    <div class="modal-overlay" id="upgradeModal" onclick="closeUpgradeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <!-- Close X -->
            <img src="assets/icon-close.png"
                style="position:absolute; top:16px; right:16px; width:28px; height:28px; cursor:pointer;"
                onclick="closeUpgradeModal()">

            <div id="upgradeStep1">
                <div class="upgrade-title">
                    UPGRADE TO<br>PRO
                </div>

                <ul class="upgrade-list">
                    <li>No ads</li>
                    <li>Saves full season of game data</li>
                    <li>Saves full season of player data</li>
                    <li>Saves coach data</li>
                    <li>Permanent match history</li>
                </ul>

                <button class="purchase-btn" onclick="showPricingOptions()">PURCHASE NOW</button>
                <div class="cancel-text">Cancel anytime</div>
            </div>

            <div id="upgradeStep2" style="display:none;">
                <div class="upgrade-title">
                    UPGRADE TO<br>PRO
                </div>

                <!-- Option 1 -->
                <div class="pricing-option" onclick="selectPricing('monthly')">
                    <div class="pricing-price">$5.99/month</div>
                    <div class="pricing-period">Billed monthly</div>
                </div>

                <div class="separator-or">Or</div>

                <!-- Option 2 -->
                <div class="pricing-option" onclick="selectPricing('halfyearly')">
                    <div class="pricing-price">$29.99/6 months</div>
                    <div class="pricing-period">Billed half yearly</div>
                </div>

                <div class="cancel-text" style="margin-top:24px;">Cancel anytime</div>
            </div>

        </div>
    </div>

    <!-- Logic -->
    <script>
        // ... (Previous logic) ...

        // Upgrade Modal Logic
        function openUpgradeModal() {
            // Reset to step 1
            document.getElementById('upgradeStep1').style.display = 'block';
            document.getElementById('upgradeStep2').style.display = 'none';
            document.getElementById('upgradeModal').classList.add('active');
        }

        function closeUpgradeModal(e) {
            if (e) e.stopPropagation();
            document.getElementById('upgradeModal').classList.remove('active');
        }

        function showPricingOptions() {
            document.getElementById('upgradeStep1').style.display = 'none';
            document.getElementById('upgradeStep2').style.display = 'block';
        }

        function selectPricing(plan) {
            alert('Selected plan: ' + plan + '. Payment gateway to be implemented.');
        }

        // Practice Match Flow - Set flag for authenticated coaches
        // Practice Match Flow - Set flag for authenticated coaches
        function handlePracticeGameClick() {
            // Use URL parameter for robust mode detection (avoids session storage race conditions)
            const timestamp = Date.now();
            window.location.href = `basketball.html?mode=practice&v=${timestamp}`;
        }
    </script>
</body>

</html>